

<!doctype html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>roadnetwork_rg.datafile &#8212; roadnetwork_rg 0.1.0rc2 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bizstyle.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">roadnetwork_rg 0.1.0rc2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">roadnetwork_rg.datafile</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for roadnetwork_rg.datafile</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Implementation of an I/O class for :class:`.WorldData` used by :class:`.WorldGenerator`&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="kn">from</span> <span class="nn">.common</span> <span class="kn">import</span> <span class="n">PixelPath</span><span class="p">,</span> <span class="n">PointType</span><span class="p">,</span> <span class="n">SeedType</span><span class="p">,</span> <span class="n">WorldConfig</span><span class="p">,</span> <span class="n">WorldChunkData</span><span class="p">,</span> <span class="n">WorldData</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="DatafileDecodeError"><a class="viewcode-back" href="../../roadnetwork_rg.datafile.html#roadnetwork_rg.datafile.DatafileDecodeError">[docs]</a><span class="k">class</span> <span class="nc">DatafileDecodeError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;File corruption found.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="DatafileEncodingError"><a class="viewcode-back" href="../../roadnetwork_rg.datafile.html#roadnetwork_rg.datafile.DatafileEncodingError">[docs]</a><span class="k">class</span> <span class="nc">DatafileEncodingError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unexpected data.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Datafile"><a class="viewcode-back" href="../../roadnetwork_rg.datafile.html#roadnetwork_rg.datafile.Datafile">[docs]</a><span class="k">class</span> <span class="nc">Datafile</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Implements an I/O file handler for :class:`.WorldData`.</span>


<span class="sd">    **Use cases**::</span>

<span class="sd">        Datafile.save(filename, key, data)</span>
<span class="sd">        data = Datafile.load(filename, key)</span>

<span class="sd">        file = Datafile()</span>
<span class="sd">        file.set_data(data)</span>
<span class="sd">        file.write(filename, key)</span>

<span class="sd">        file = Datafile()</span>
<span class="sd">        file.read(filename, key)</span>
<span class="sd">        data = file2.get_data()</span>

<span class="sd">    **File format**</span>

<span class="sd">    * all numbers are in little endian</span>

<span class="sd">    ============== =================</span>
<span class="sd">        size        description</span>
<span class="sd">    ============== =================</span>
<span class="sd">       10 bytes      magic number</span>
<span class="sd">        3 bytes     version number</span>
<span class="sd">       64 bytes      header checksum</span>
<span class="sd">        2 bytes       data offset</span>
<span class="sd">     -- 1 byte --   -- separator --</span>
<span class="sd">     header:</span>
<span class="sd">        4 bytes         content length (4Gb data max)</span>
<span class="sd">       64 bytes         signature</span>
<span class="sd">     -- 1 byte --   -- separator --</span>
<span class="sd">     data:</span>
<span class="sd">        1 byte         seed type (None:0, int:1, str:2, bytes:3, bytearray:4)</span>
<span class="sd">        1 byte        length of seed</span>
<span class="sd">        varied            seed</span>
<span class="sd">     -- 1 byte --   --    pad    --</span>
<span class="sd">        8 bytes        safe_seed</span>
<span class="sd">     -- 1 byte --   --    pad    --</span>
<span class="sd">        1 byte      length of config (future proof, currently 43)</span>
<span class="sd">        varied           config (pickled format)</span>
<span class="sd">     -- 1 byte --   --    pad    --</span>
<span class="sd">     chunks:</span>
<span class="sd">        2 bytes     number of chunks</span>
<span class="sd">     -- 1 byte --   -- separator --</span>
<span class="sd">     chunk:</span>
<span class="sd">        4 bytes           x</span>
<span class="sd">        4 bytes           y</span>
<span class="sd">        2 bytes     length of cities</span>
<span class="sd">        varied          cities (pickled format)</span>
<span class="sd">     -- 1 byte --   --    pad    --</span>
<span class="sd">        2 bytes     number of paths</span>
<span class="sd">     -- 1 byte --   -- separator --</span>
<span class="sd">     pixel_path:</span>
<span class="sd">        8 bytes          cost</span>
<span class="sd">        6 byte          source (2, 2, 2 byte)</span>
<span class="sd">        6 byte          target (2, 2, 2 byte)</span>
<span class="sd">        2 bytes     length of pixels</span>
<span class="sd">        varied          pixels (pickled format)</span>
<span class="sd">     -- 1 byte --   -- separator --</span>
<span class="sd">        4 bytes     length of height_map</span>
<span class="sd">        varied         height_map (in TIFF format)</span>
<span class="sd">     -- 1 byte --   -- separator --</span>
<span class="sd">        4 bytes     length of potential_map</span>
<span class="sd">        varied        potential_map (in TIFF format)</span>
<span class="sd">     -- 1 byte --   -- separator -- (if not last)</span>
<span class="sd">    ============== =================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__version</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">__compatible_versions</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">__magic</span> <span class="o">=</span> <span class="s1">&#39;#D-MG#WG-D&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
    <span class="n">__header_checksum_length</span> <span class="o">=</span> <span class="mi">64</span>  <span class="c1"># from `hashlib` `sha512` method `digest_size`</span>
    <span class="n">__data_signature_length</span> <span class="o">=</span> <span class="mi">64</span>  <span class="c1"># from `hmac` `digest_size` with `sha512` method</span>

<div class="viewcode-block" id="Datafile.__init__"><a class="viewcode-back" href="../../roadnetwork_rg.datafile.html#roadnetwork_rg.datafile.Datafile.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span></div>

<div class="viewcode-block" id="Datafile.set_data"><a class="viewcode-back" href="../../roadnetwork_rg.datafile.html#roadnetwork_rg.datafile.Datafile.set_data">[docs]</a>    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">:</span> <span class="n">WorldData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sets binary data.</span>

<span class="sd">        Data can be to be saved by :meth:`write` or parsed by :meth:`get_data`.</span>

<span class="sd">        :param world: Data to be set.</span>
<span class="sd">        :type world: :class:`.WorldData`</span>
<span class="sd">        :raises: :exc:`TypeError`, if type of :attr:`world.seed` is not allowed.</span>
<span class="sd">            Only  :class:`None`, :class:`int`, :class:`str`, :class:`bytes`, and :class:`bytearray`</span>
<span class="sd">            are supported types</span>
<span class="sd">        :raises: :exc:`DatafileEncodingError`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># IDEA: use 2 bit `seed_type` instead byte?</span>
        <span class="k">if</span> <span class="n">world</span><span class="o">.</span><span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seed_type</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">seed_type</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">((</span><span class="n">world</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s1">&#39;little&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">seed_type</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)):</span>
            <span class="n">seed_type</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="mi">4</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">seed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unsupported seed type of </span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;it should be either None, int, str, bytes, or bytearray&quot;</span> <span class="o">%</span>
                            <span class="nb">type</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span><span class="p">[:</span><span class="mi">255</span><span class="p">]</span>  <span class="c1"># first 255 bytes (if larger)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="o">*</span><span class="n">world</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileEncodingError</span><span class="p">(</span><span class="s2">&quot;Failed to encode config&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileEncodingError</span><span class="p">(</span><span class="s2">&quot;Too large seed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileEncodingError</span><span class="p">(</span><span class="s2">&quot;Too large config&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">config_pack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
                <span class="s1">&#39;&lt;B B </span><span class="si">%d</span><span class="s1">s x Q x B </span><span class="si">%d</span><span class="s1">s x H&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seed</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">)),</span>
                <span class="n">seed_type</span><span class="p">,</span>  <span class="c1"># 1 byte</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">seed</span><span class="p">),</span>  <span class="c1"># 1 byte</span>
                <span class="n">seed</span><span class="p">,</span>  <span class="c1"># varied</span>
                <span class="c1"># pad 1 byte</span>
                <span class="n">world</span><span class="o">.</span><span class="n">safe_seed</span><span class="p">,</span>  <span class="c1"># 8 bytes</span>
                <span class="c1"># pad 1 byte</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">),</span>  <span class="c1"># 1 byte</span>
                <span class="n">config</span><span class="p">,</span>  <span class="c1"># 43 bytes</span>
                <span class="c1"># pad 1 byte</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">chunks</span><span class="p">)</span>  <span class="c1"># 2 bytes</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileEncodingError</span><span class="p">(</span><span class="s2">&quot;Failed to encode config&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\00</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
            <span class="n">config_pack</span><span class="p">,</span>
            <span class="c1"># separator 1 byte</span>
            <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\00</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encode_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">world</span><span class="o">.</span><span class="n">chunks</span><span class="p">)</span>
        <span class="p">))</span></div>

<div class="viewcode-block" id="Datafile.get_data"><a class="viewcode-back" href="../../roadnetwork_rg.datafile.html#roadnetwork_rg.datafile.Datafile.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WorldData</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parses binary data of file.</span>

<span class="sd">        Data can be loaded by :meth:`read` or set by :meth:`set_data`.</span>

<span class="sd">        :return: Parsed data.</span>
<span class="sd">        :rtype: :class:`.WorldData`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">seed_type</span><span class="p">,</span> <span class="n">seed_length</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                <span class="s1">&#39;&lt;B B&#39;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Failed to decode  seed type and length&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">seed</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                <span class="s1">&#39;&lt;</span><span class="si">%d</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="n">seed_length</span><span class="p">,</span>
                <span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">seed_length</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Failed to decode seed&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="n">seed</span><span class="p">:</span> <span class="n">SeedType</span>
        <span class="k">if</span> <span class="n">seed_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># None</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">seed_length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Non-zero seed length of None seed&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">seed_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># int</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">seed_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># str</span>
                <span class="n">seed</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">seed</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">seed_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># bytes</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">seed_type</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># bytearray</span>
                <span class="n">seed</span><span class="p">:</span> <span class="nb">bytearray</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Unrecognised seed type&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_delimiter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">safe_seed</span><span class="p">:</span> <span class="nb">int</span>
            <span class="n">safe_seed</span><span class="p">,</span> <span class="n">config_length</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                <span class="s1">&#39;&lt;Q x B&#39;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Failed to decode safe_seed and length of config&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">config</span><span class="p">:</span> <span class="n">WorldConfig</span> <span class="o">=</span> <span class="n">WorldConfig</span><span class="p">(</span><span class="o">*</span><span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_length</span><span class="p">)))</span>
        <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">UnpicklingError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Failed to decode config&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_delimiter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">chunks_count</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                <span class="s1">&#39;&lt;H&#39;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Failed to decode length of chunks&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_delimiter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">WorldChunkData</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Datafile</span><span class="o">.</span><span class="n">_read_list_item</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunks_count</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Datafile</span><span class="o">.</span><span class="n">decode_chunk</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">chunks_count</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">WorldData</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">safe_seed</span><span class="p">,</span> <span class="n">chunks</span><span class="p">)</span></div>

<div class="viewcode-block" id="Datafile.clear_data"><a class="viewcode-back" href="../../roadnetwork_rg.datafile.html#roadnetwork_rg.datafile.Datafile.clear_data">[docs]</a>    <span class="k">def</span> <span class="nf">clear_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Clears data set for :class:`Datafile` instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span></div>

<div class="viewcode-block" id="Datafile.write"><a class="viewcode-back" href="../../roadnetwork_rg.datafile.html#roadnetwork_rg.datafile.Datafile.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Writes data to a file, signs data using hashing algorithm.</span>

<span class="sd">        :param filename: It is the name of the destination to where data is saved.</span>
<span class="sd">        :type filename: :data:`~typing.Union` [:class:`str`, :class:`bytes` ]</span>
<span class="sd">        :param key: Hash key to be used signing data.</span>
<span class="sd">        :type key: :class:`bytes` (i.g. returned by :meth:`str.encode`)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4294967295</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileEncodingError</span><span class="p">(</span><span class="s2">&quot;Too large data&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha512</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
            <span class="c1"># fail-safe (overkill)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_signature_length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DatafileEncodingError</span><span class="p">(</span><span class="s2">&quot;Too large data signature&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
                    <span class="s1">&#39;&lt;L </span><span class="si">%d</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_signature_length</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">),</span>  <span class="c1"># 4 bytes</span>
                    <span class="n">signature</span><span class="p">,</span>  <span class="c1"># 64 bytes</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DatafileEncodingError</span><span class="p">(</span><span class="s2">&quot;Failed to encode header&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

            <span class="n">checksum</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha512</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
            <span class="c1"># fail-safe (overkill)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">checksum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__header_checksum_length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DatafileEncodingError</span><span class="p">(</span><span class="s2">&quot;Too large header checksum&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">magic</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
                    <span class="s1">&#39;&lt;10s BBB </span><span class="si">%d</span><span class="s1">s H&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__header_checksum_length</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__magic</span><span class="p">,</span>  <span class="c1"># 10 bytes</span>
                    <span class="o">*</span><span class="n">Datafile</span><span class="o">.</span><span class="n">__version</span><span class="p">,</span>  <span class="c1"># 3 bytes</span>
                    <span class="n">checksum</span><span class="p">,</span>  <span class="c1"># 64 bytes</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">),</span>  <span class="c1"># 2 bytes</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DatafileEncodingError</span><span class="p">(</span><span class="s2">&quot;Failed to encode magic&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\00</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
                <span class="n">magic</span><span class="p">,</span>
                <span class="c1"># separator 1 byte</span>
                <span class="n">header</span><span class="p">,</span>
                <span class="c1"># separator 1 byte</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
            <span class="p">)))</span></div>

<div class="viewcode-block" id="Datafile.read"><a class="viewcode-back" href="../../roadnetwork_rg.datafile.html#roadnetwork_rg.datafile.Datafile.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Reads data from file, authenticating data using hashing algorithm</span>

<span class="sd">        :param filename: It is the name of the source from where data is read.</span>
<span class="sd">        :type filename: :data:`~typing.Union` [:class:`str`, :class:`bytes`]</span>
<span class="sd">        :param key: Hash key to be used authenticating data.</span>
<span class="sd">        :type key: :class:`bytes` (i.g. returned by :meth:`str.encode`)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">checksum</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_magic</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_delimiter</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">content_length</span><span class="p">,</span> <span class="n">signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_header</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">checksum</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_check_delimiter</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">signature</span> <span class="o">!=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha512</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Invalid data signature&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Datafile.get_version"><a class="viewcode-back" href="../../roadnetwork_rg.datafile.html#roadnetwork_rg.datafile.Datafile.get_version">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_version</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets version of file format.</span>

<span class="sd">        :return: It is a string of the file format&#39;s version numbers separated by dots.</span>
<span class="sd">        :rtype: :class:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__version</span><span class="p">))</span></div>

<div class="viewcode-block" id="Datafile.save"><a class="viewcode-back" href="../../roadnetwork_rg.datafile.html#roadnetwork_rg.datafile.Datafile.save">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">world</span><span class="p">:</span> <span class="n">WorldData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Saves data to file.</span>

<span class="sd">        Creates an instance, sets data and writes it to destination.</span>
<span class="sd">        (see: :meth:`set_data` and :meth:`write`)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">file</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">file</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">world</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="Datafile.load"><a class="viewcode-back" href="../../roadnetwork_rg.datafile.html#roadnetwork_rg.datafile.Datafile.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Datafile</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Loads data from file.</span>

<span class="sd">        Creates an instance and reads data. (see: :meth:`read`)</span>

<span class="sd">        :return: It is the instance created.</span>
<span class="sd">        :rtype: :class:`Datafile`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span></div>

<div class="viewcode-block" id="Datafile.encode_chunk"><a class="viewcode-back" href="../../roadnetwork_rg.datafile.html#roadnetwork_rg.datafile.Datafile.encode_chunk">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">encode_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">:</span> <span class="n">WorldChunkData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Encodes a chunk.</span>

<span class="sd">        :param chunk: It is the object to be encoded.</span>
<span class="sd">        :type chunk: :class:`.WorldChunkData`</span>
<span class="sd">        :return: It is the encoded data.</span>
<span class="sd">        :rtype: :class:`bytes`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cities</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">cities</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileEncodingError</span><span class="p">(</span><span class="s2">&quot;Failed to encode cities&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cities</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileEncodingError</span><span class="p">(</span><span class="s2">&quot;Too large cities&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">BytesIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">buff</span><span class="p">:</span>
            <span class="n">chunk</span><span class="o">.</span><span class="n">height_map</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;TIFF&#39;</span><span class="p">)</span>
            <span class="n">height_map</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">height_map</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4294967295</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileEncodingError</span><span class="p">(</span><span class="s2">&quot;Too large height_map&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">BytesIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">buff</span><span class="p">:</span>
            <span class="n">chunk</span><span class="o">.</span><span class="n">potential_map</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;TIFF&#39;</span><span class="p">)</span>
            <span class="n">potential_map</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">height_map</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4294967295</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileEncodingError</span><span class="p">(</span><span class="s2">&quot;Too large potential_map&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">chunk_pack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
                <span class="s1">&#39;&lt;i i H </span><span class="si">%d</span><span class="s1">s x H&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">cities</span><span class="p">),</span>
                <span class="n">chunk</span><span class="o">.</span><span class="n">offset_x</span><span class="p">,</span>  <span class="c1"># 4 bytes</span>
                <span class="n">chunk</span><span class="o">.</span><span class="n">offset_y</span><span class="p">,</span>  <span class="c1"># 4 bytes</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">cities</span><span class="p">),</span>  <span class="c1"># 2 bytes</span>
                <span class="n">cities</span><span class="p">,</span>  <span class="c1"># varied</span>
                <span class="c1"># pad 1 byte</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">pixel_paths</span><span class="p">)</span>  <span class="c1"># 2 bytes</span>
            <span class="p">)</span>
            <span class="n">height_map_pack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
                <span class="s1">&#39;&lt;L </span><span class="si">%d</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">height_map</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">height_map</span><span class="p">),</span>  <span class="c1"># 2 bytes</span>
                <span class="n">height_map</span>  <span class="c1"># varied</span>
            <span class="p">)</span>
            <span class="n">potential_map_pack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
                <span class="s1">&#39;&lt;L </span><span class="si">%d</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">potential_map</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">potential_map</span><span class="p">),</span>  <span class="c1"># 2 bytes</span>
                <span class="n">potential_map</span>  <span class="c1"># varied</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileEncodingError</span><span class="p">(</span><span class="s2">&quot;Failed to encode chunk&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\00</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
            <span class="n">chunk_pack</span><span class="p">,</span>
            <span class="c1"># separator 1 byte</span>
            <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\00</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Datafile</span><span class="o">.</span><span class="n">encode_pixel_path</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">chunk</span><span class="o">.</span><span class="n">pixel_paths</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
            <span class="c1"># separator 1 byte</span>
            <span class="n">height_map_pack</span><span class="p">,</span>
            <span class="c1"># separator 1 byte</span>
            <span class="n">potential_map_pack</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Datafile.decode_chunk"><a class="viewcode-back" href="../../roadnetwork_rg.datafile.html#roadnetwork_rg.datafile.Datafile.decode_chunk">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">decode_chunk</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WorldChunkData</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Reads data and decodes it.</span>

<span class="sd">        :param data: It is a buffer from data to be read.</span>
<span class="sd">        :type data: :class:`~typing.BinaryIO`</span>
<span class="sd">        :return: It is the decoded data.</span>
<span class="sd">        :rtype: :class:`.WorldChunkData`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">offset_x</span><span class="p">:</span> <span class="nb">int</span>
            <span class="n">offset_y</span><span class="p">:</span> <span class="nb">int</span>
            <span class="n">offset_x</span><span class="p">,</span> <span class="n">offset_y</span><span class="p">,</span> <span class="n">cities_length</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                <span class="s1">&#39;&lt;i i H&#39;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span>
                <span class="s2">&quot;Failed to decode offset_x, offset_y and/or length of chunk&#39;s cities attribute&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cities</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PointType</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cities_length</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">UnpicklingError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Failed to decode cities&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="n">Datafile</span><span class="o">.</span><span class="n">_check_delimiter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pixel_paths_count</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                <span class="s1">&#39;&lt;H&#39;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Failed to decode length of pixel_paths&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="n">Datafile</span><span class="o">.</span><span class="n">_check_delimiter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">pixel_paths</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">PointType</span><span class="p">,</span> <span class="n">PointType</span><span class="p">],</span> <span class="n">PixelPath</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">Datafile</span><span class="o">.</span><span class="n">_read_list_item</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pixel_paths_count</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Datafile</span><span class="o">.</span><span class="n">decode_pixel_path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pixel_paths_count</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">Datafile</span><span class="o">.</span><span class="n">_check_delimiter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">height_map_length</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                <span class="s1">&#39;&lt;L&#39;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">height_map</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">height_map_length</span><span class="p">)))</span>
        <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Failed to decode length of height_map&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="n">Datafile</span><span class="o">.</span><span class="n">_check_delimiter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">potential_map_length</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                <span class="s1">&#39;&lt;L&#39;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Failed to decode length of potential_map&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="n">potential_map</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">potential_map_length</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">WorldChunkData</span><span class="p">(</span><span class="n">offset_x</span><span class="p">,</span> <span class="n">offset_y</span><span class="p">,</span> <span class="n">height_map</span><span class="p">,</span> <span class="n">cities</span><span class="p">,</span> <span class="n">potential_map</span><span class="p">,</span> <span class="n">pixel_paths</span><span class="p">)</span></div>

<div class="viewcode-block" id="Datafile.encode_pixel_path"><a class="viewcode-back" href="../../roadnetwork_rg.datafile.html#roadnetwork_rg.datafile.Datafile.encode_pixel_path">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">encode_pixel_path</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">PointType</span><span class="p">,</span> <span class="n">PointType</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="n">PixelPath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Encodes a key-value pair.</span>

<span class="sd">        :param key: It is a pair of points corresponding to the ends of *path*.</span>
<span class="sd">        :type key: :class:`tuple` [:data:`.PointType`, :data:`.PointType` ]</span>
<span class="sd">        :param path: It is a path between the tow point in *key*.</span>
<span class="sd">        :type path: :class:`.PixelPath`</span>
<span class="sd">        :return: It is the encoded data.</span>
<span class="sd">        :rtype: :class:`bytes`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pixels</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">pixels</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileEncodingError</span><span class="p">(</span><span class="s2">&quot;Failed to encode pixels&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileEncodingError</span><span class="p">(</span><span class="s2">&quot;Too large pixels&quot;</span><span class="p">)</span>

        <span class="n">source</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
                <span class="s1">&#39;&lt;d HHH HHH H </span><span class="si">%d</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">pixels</span><span class="p">),</span>
                <span class="n">path</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>  <span class="c1"># 8 bytes</span>
                <span class="o">*</span><span class="n">source</span><span class="p">,</span>
                <span class="o">*</span><span class="n">target</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">pixels</span><span class="p">),</span>  <span class="c1"># 2 bytes</span>
                <span class="n">pixels</span>  <span class="c1"># varied</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileEncodingError</span><span class="p">(</span><span class="s2">&quot;Failed to encode PixelPath&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Datafile.decode_pixel_path"><a class="viewcode-back" href="../../roadnetwork_rg.datafile.html#roadnetwork_rg.datafile.Datafile.decode_pixel_path">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">decode_pixel_path</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">PointType</span><span class="p">,</span> <span class="n">PointType</span><span class="p">],</span> <span class="n">PixelPath</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Reads data and decodes it.</span>

<span class="sd">        :param data: It is the buffer from data to be read.</span>
<span class="sd">        :type data: :class:`~typing.BinaryIO`</span>
<span class="sd">        :return: It is a *key-value* pair, *key* is a pair of points corresponding to the ends of</span>
<span class="sd">            the *value* which is a path between them.</span>
<span class="sd">        :rtype: :class:`tuple` [:class:`tuple` [:data:`.PointType`, :data:`.PointType` ],</span>
<span class="sd">            :class:`.PixelPath` ]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cost</span><span class="p">:</span> <span class="nb">float</span>
            <span class="p">(</span><span class="n">cost</span><span class="p">,</span>
             <span class="n">source_x</span><span class="p">,</span> <span class="n">source_y</span><span class="p">,</span> <span class="n">source_z</span><span class="p">,</span>
             <span class="n">target_x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">target_z</span><span class="p">,</span>
             <span class="n">pixels_length</span>
             <span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                <span class="s1">&#39;&lt;d HHH HHH H&#39;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Failed to decode&quot;</span>
                                      <span class="s2">&quot; PixelPath cost and length of pixels&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pixels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">pixels_length</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">UnpicklingError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Failed to decode pixels&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">PointType</span><span class="p">,</span> <span class="n">PointType</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">source_x</span><span class="p">,</span> <span class="n">source_y</span><span class="p">,</span> <span class="n">source_z</span><span class="p">),</span>
                                            <span class="p">(</span><span class="n">target_x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">target_z</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">PixelPath</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="n">pixels</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_read_list_item</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
                        <span class="n">item_decoder</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">BinaryIO</span><span class="p">],</span> <span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">item_decoder</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># NOTE: there might be a better pattern</span>
        <span class="c1"># if there is a surrounding `delimiter` it could be handled</span>
        <span class="c1"># here, or before the `_decode_pixel_path` call</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">delimiter</span><span class="p">))</span> <span class="o">!=</span> <span class="n">delimiter</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DatafileDecodeError</span>
        <span class="k">return</span> <span class="n">item</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_delimiter</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\00</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_read_magic</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">compatible_versions</span> <span class="o">=</span> <span class="n">Datafile</span><span class="o">.</span><span class="n">__compatible_versions</span> <span class="o">+</span> <span class="p">(</span><span class="n">Datafile</span><span class="o">.</span><span class="n">__version</span><span class="p">,)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">magic</span><span class="p">,</span>
             <span class="n">vmajor</span><span class="p">,</span> <span class="n">vminor</span><span class="p">,</span> <span class="n">vpatch</span><span class="p">,</span>
             <span class="n">checksum</span><span class="p">,</span>
             <span class="n">offset</span><span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                <span class="s1">&#39;&lt;10s BBB </span><span class="si">%d</span><span class="s1">s H&#39;</span> <span class="o">%</span> <span class="n">Datafile</span><span class="o">.</span><span class="n">__header_checksum_length</span><span class="p">,</span>
                <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">79</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Failed to decode magic&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
        <span class="k">if</span> <span class="n">magic</span> <span class="o">!=</span> <span class="n">Datafile</span><span class="o">.</span><span class="n">__magic</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Argument filename has unrecognised format&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vmajor</span><span class="p">,</span> <span class="n">vminor</span><span class="p">,</span> <span class="n">vpatch</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compatible_versions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Argument filename has a non-compatible version&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">checksum</span><span class="p">,</span> <span class="n">offset</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_read_header</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">checksum</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">checksum</span> <span class="o">!=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha512</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Invalid headed checksum&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">content_length</span><span class="p">,</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                <span class="s1">&#39;&lt;L </span><span class="si">%d</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="n">Datafile</span><span class="o">.</span><span class="n">__data_signature_length</span><span class="p">,</span>
                <span class="n">header</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatafileDecodeError</span><span class="p">(</span><span class="s2">&quot;Failed to decode header&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
        <span class="k">return</span> <span class="n">content_length</span><span class="p">,</span> <span class="n">signature</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">roadnetwork_rg 0.1.0rc2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">roadnetwork_rg.datafile</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, kos Slyi.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.0.2.
    </div>
  </body>
</html>